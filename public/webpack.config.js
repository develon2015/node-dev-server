/*
 * Generated by node-dev-server
 *
 * @author Develon (https://github.com/develon2015)
 */

const path = require('path');

const DIR_PROJECT = path.resolve(__dirname, '.');
const DIR_SRC = path.resolve(DIR_PROJECT, 'src');
const DIR_DIST = path.resolve(DIR_PROJECT, 'dist');

const CONFIG = {
    // target: 'electron-renderer', // 避免打包'electron'
    target: 'node',
    mode: 'development',
    // devtool: 'source-map',
    entry: {
        main: path.resolve(DIR_SRC),
    },
    output: {
        filename: '[name].js',
        path: DIR_DIST,
        libraryTarget: 'commonjs2',
        chunkFilename: 'async/[id]-module-[name].js', // 此选项确定非入口块文件的名称
    },
    module: {
        rules: [
            { test: /\.tsx?$/, exclude: /node_modules/, loader: `@BABEL_LOADER` }, // @BABEL_LOADER及其预设由nds提供
        ],
    },
    resolve: {
        extensions: ['.ts', '.js', '.json', '.tsx'],
        alias: {
            '@': DIR_SRC,
        },
    },
};

function config(env = {}, argv = {}) {
    if (env && (env.production || env.rebuild)) {
        console.log('Build production');
        CONFIG.mode = 'production';
        delete CONFIG.devtool;
        delete CONFIG.devServer;
    }
    if (env && env.rebuild) {
        console.log('Rebuild production');
        console.log('OS:', process.platform);
        try {
            const child_process = require('child_process');
            if (process.platform.match(/^win.*/)) { // Implement this on Windows OS
                child_process.execSync(`rmdir /S /Q "${DIR_DIST}"`);
            } else if (process.platform.match(/^linux.*/)) { // Implement this on Linux OS
                child_process.execSync(`rm -rf '${DIR_DIST}'`);
            }
        } catch (error) { }
    }
    return CONFIG;
}

module.exports = config;
